<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Las Aventuras de los Tres</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />

  <!-- Pre-carga para arrancar más rápido -->
  <link rel="preload" as="image" href="images/1.png" fetchpriority="high">
  <link rel="prefetch" as="image" href="images/2.png">
  <link rel="prefetch" as="image" href="images/3.png">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Fuente clara y legible */
    @import url('https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap');
    body { 
      font-family: 'Atkinson Hyperlegible', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, sans-serif;
      color: #1f2937; /* gray-800 */
    }

    /* Contenedor con perspectiva para efecto libro */
    #book  { perspective: 1400px; }
    #sheet { will-change: transform; transform-style: preserve-3d; }

    /* Animaciones del “pase de página” */
    .turn-out-next  { transform-origin: right center;  animation: turnOutNext 220ms ease forwards; }
    .turn-in-next   { transform-origin: right center;  animation: turnInNext  220ms ease forwards; }
    .turn-out-prev  { transform-origin: left  center;  animation: turnOutPrev 220ms ease forwards; }
    .turn-in-prev   { transform-origin: left  center;  animation: turnInPrev  220ms ease forwards; }
    @keyframes turnOutNext { to   { transform: rotateY(-90deg); } }
    @keyframes turnInNext  { from { transform: rotateY( 90deg); } to { transform: rotateY(0deg); } }
    @keyframes turnOutPrev { to   { transform: rotateY( 90deg); } }
    @keyframes turnInPrev  { from { transform: rotateY(-90deg); } to { transform: rotateY(0deg); } }

    /* Flechas solo sobre la imagen */
    #imageWrap { position: relative; }
    .image-controls { opacity: 0; visibility: hidden; transition: opacity .18s ease; }
    .group:hover .image-controls, .show-controls .image-controls { opacity: 1; visibility: visible; }

    /* Blur-up mientras llega la imagen nueva */
    .img-loading { filter: blur(8px); transform: scale(1.01); transition: filter .2s ease, transform .2s ease; }
  </style>
</head>
<body class="bg-yellow-50 flex items-center justify-center min-h-screen p-4">
  <div id="book" class="w-full max-w-3xl">
    <div id="sheet" class="bg-white shadow-xl rounded-2xl overflow-hidden">
      <!-- Imagen + flechas (no pisan el texto) -->
      <div id="imageWrap" class="group">
        <img id="imagen"
             class="w-full object-cover"
             alt="Ilustración de página"
             decoding="async"
             fetchpriority="high"
             width="1200" height="675" />
        <button id="prev"
                class="image-controls absolute left-3 top-1/2 -translate-y-1/2 p-3 rounded-full bg-green-600 text-white shadow"
                aria-label="Página anterior">◀</button>
        <button id="next"
                class="image-controls absolute right-3 top-1/2 -translate-y-1/2 p-3 rounded-full bg-blue-600 text-white shadow"
                aria-label="Página siguiente">▶</button>
      </div>

      <!-- Texto más legible -->
      <div id="texto" class="px-6 md:px-8 py-5 mt-2 text-[1.125rem] md:text-[1.25rem] leading-8 md:leading-9" tabindex="0"></div>
    </div>
  </div>

  <!-- Gestos táctiles -->
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
  <script>
    // ====== Estado ======
    let paginas = [];
    let idx = 0;                 // Siempre arranca en la página 0 (1 para el usuario)
    let locked = false;          // Bloquea mientras animamos/cargamos
    let pendingIndex = null;     // Último destino solicitado durante el bloqueo

    // ====== Elementos ======
    const sheet     = document.getElementById('sheet');
    const imgEl     = document.getElementById('imagen');
    const textoEl   = document.getElementById('texto');
    const prevBtn   = document.getElementById('prev');
    const nextBtn   = document.getElementById('next');
    const imageWrap = document.getElementById('imageWrap');

    // ====== Utilidades ======
    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
    const setDisabled = (s) => {
      prevBtn.disabled = s || idx === 0;
      nextBtn.disabled = s || idx === paginas.length - 1;
      prevBtn.classList.toggle('opacity-50', prevBtn.disabled);
      nextBtn.classList.toggle('opacity-50', nextBtn.disabled);
    };
    const preloadSrc = (i) => { const p = new Image(); p.src = `images/${i+1}.png`; };

    // Carga imagen y hace swap a mitad de la animación (con tiempo máximo)
    async function flipTo(target, dir) {
      if (locked || target === idx) return;

      locked = true;
      setDisabled(true);

      const outClass = dir === 'next' ? 'turn-out-next' : 'turn-out-prev';
      const inClass  = dir === 'next' ? 'turn-in-next'  : 'turn-in-prev';
      const phaseMs  = 220;         // duración de cada fase
      const maxWait  = 450;         // tiempo máx. de espera si decode tarda

      // Fase 1: giro de salida
      sheet.classList.remove('turn-in-next','turn-in-prev');
      sheet.classList.add(outClass);

      // Prepara siguiente imagen
      const src = `images/${target+1